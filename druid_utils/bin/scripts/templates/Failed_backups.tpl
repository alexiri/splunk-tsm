<%inherit file="/user_msg.tpl" />


<%def name="titleEN()">
    Failed backups for contact ${contact}
</%def>
<%def name="titleFR()">
    Backups manqu&eacute;s pour le contact ${contact}
</%def>


<%def name="textEN()">
    <p>Dear ${contact},</p>

    % if nodes:
    <p><b class="red">${len(nodes)}</b> of your nodes ${'have' if len(nodes)>1 else 'has'} had problems with ${'their' if len(nodes)>1 else 'its'} scheduled backups. <a href="#nodes">(full list below)</a></p>
    % endif

    % if filespaces:
    <p><b class="red">${len(filespaces)}</b> of your nodes ${'have' if len(filespaces)>1 else 'has'} filespaces that have not been backed up. <a href="#filespaces">(full list below)</a></p>
    % endif
</%def>
<%def name="textFR()">
    <p>Cher ${contact},</p>

    % if nodes:
    <p><b class="red">${len(nodes)}</b> de vos n&oelig;uds ${'ont' if len(nodes)>1 else 'a'} eu des probl&egrave;mes avec ${'leurs' if len(nodes)>1 else 'ses'} backups p&eacute;riodiques. <a href="#nodes">(liste ci-dessous)</a></p>
    % endif

    % if filespaces:
    <p><b class="red">${len(filespaces)}</b> de vos n&oelig;uds n&#39;${'ont' if len(filespaces)>1 else 'a'} pas sauvegard&eacute;${'s' if len(filespaces)>1 else ''} certains filespaces. <a href="#filespaces">(liste ci-dessous)</a></p>
    % endif
</%def>


<%def name="actionsEN()">
    <p>Review all nodes in the list of failures to identify and fix the root causes. This investigation is the responsibility of the user of the backup service. Repeated backup failures may lead to revoking of the access to the backup service and deletion of the backup data.</p>

    % if nodes:
    <p>The <a href="#nodes">table of failed schedules</a> contains a list of all of the schedules that have not completed successfully and the last date that they did. For each node, the list of filespaces is also included (the grey inset box), indicating when they were last backed up.</p>
    % endif

    % if filespaces:
    <p>The <a href="#filespaces">table of failed filespaces</a> contains a list of all the filespaces that have not been backed up during their last backup cycle, which by default is 1 day.</p>
    % endif

    <p>Please consult the <a href="failed-backup-notifications">troubleshooting guide</a> for more information about common problems and how to solve them.</p>
</%def>
<%def name="actionsFR()">
    <p>Merci de v&eacute;rifier l&#39;ensemble des n&oelig;uds concern&eacute;s par ces erreurs et d&#39;en r&eacute;soudre les causes. Si ces m&ecirc;mes erreurs de backup venaient &agrave; se r&eacute;p&egrave;ter, l&#39;acc&egrave;s au service de backup pourrait &ecirc;tre r&eacute;voqu&eacute; et les donn&eacute;es sauvegard&eacute;es effac&eacute;es.</p>

    % if nodes:
    <p>Le <a href="#nodes">tableau des backups p&eacute;riodiques manqu&eacute;s</a> contient la liste de tous les backups p&eacute;riodiques qui ne se sont pas termin&eacute;s correctement ainsi que la date de la derni&egrave;re ex&eacute;cution avec succ&egrave;s. Pour chaque n&oelig;ud, la liste des filespaces est &eacute;galement incluse (sous-partie gris&eacute;e) indiquant pour chacun la date de leur dernier backup.</p>
    % endif

    % if filespaces:
    <p>Le <a href="#filespaces">tableau des filespaces manqu&eacute;s</a> contient la liste des filespaces qui n&#39;ont pas &eacute;t&eacute; sauvegard&eacute;s pendant les derni&egrave;res 24h.</p>
    % endif

    <p>Merci de consulter le <a href="failed-backup-notifications">guide de r&eacute;solution</a> pour de plus amples informations &agrave; propos des probl&egrave;mes courants et de leur r&eacute;solution.</p>
</%def>


<%def name="helpEN()">
    <ul>
        <li>In the event of any questions or problems, please contact <a href="http://backup">TSM Support</a> or the Service Desk (phone +41 22 76 77777 or <a href="mailto:service-desk@you.com">service-desk@you.com</a>)</li>
        <li class="red">Please do not reply to this message, which is generated by a robot: you will not get any answer.</li>
    </ul>
</%def>
<%def name="helpFR()">
    <ul>
        <li>En cas de questions ou de probl&egrave;mes, merci de contacter <a href="http://www.you.com/backup">TSM Support</a> ou le Service Desk (t&eacute;l&eacute;phone +41 22 76 77777 ou <a href="mailto:service-desk@you.com">service-desk@you.com</a>)</li>
        <li class="red">Merci de ne pas r&eacute;pondre &agrave; ce message, qui a &eacute;t&eacute; g&eacute;n&eacute;r&eacute; par un robot: vous n'obtiendrez pas de r&eacute;ponse.</li>
    </ul>
</%def>


<%def name="extras()">
<%
from datetime import datetime

def toInt(n):
    try:
        return str(int(float(n)))
    except (TypeError, ValueError):
        return n

def toDateStr(d):
    try:
        return datetime.fromtimestamp(float(d)).strftime('%Y-%m-%d %H:%M:%S')
    except (TypeError, ValueError):
        return d

%>
    <br/><br/>
    % if nodes:
    <a name="nodes"></a>
    <h1>Failed Schedules / Backups p&eacute;riodiques manqu&eacute;s</h1>
    <table cellspacing="0" cellpadding="0" border="0">
      <tr>
        <th class="left">TSM Server</th>
        <th class="left">Node Name</th>
        <th class="left">Node Group</th>
        <th class="left">Schedule</th>
        <th class="left">Status <sup><a href="failed-backup-notifications#schedules">(?)</a></sup></th>
        <th class="nowrap">Last successful execution</th>
        <th>Days since last successful execution</th>
      </tr>
    % for f in nodes:
      <tr>
        <td class="left">${f['tsmserver']}</td>
        <td class="left">${f['node']}</td>
        <td class="left">${f['GROUP']}</td>
        <td class="left">${ '<br/>'.join(f['client_schedule']) }</td>
        <td class="left">${ '<br/>'.join(f['status']) }</td>
        <td class="nowrap">${ '<br/>'.join([toDateStr(x) for x in f['last_completed']]) }</td>
        <td>${ '<br/>'.join([toInt(x) for x in f['days_since']]) }</td>
      </tr>
      % if f['fs_list']:
        <tr>
          <td></td>
          <td></td>
          <td class="insert-left">${ '<br/>'.join(f['fs_list']) }</td>
          <td class="insert">&nbsp;</td>
          <td class="insert">&nbsp;</td>
          <td class="insert">${ '<br/>'.join([toDateStr(x) for x in f['fs_last_completed']]) if filter(None, f['fs_last_completed']) else '&nbsp;' }</td>
          <td class="insert-right">${ '<br/>'.join([toInt(x) for x in f['fs_days_since']]) if filter(None, f['fs_days_since']) else '&nbsp;' }</td>
        </tr>
      % endif
    % endfor
    </table>
    % endif

    % if filespaces:
    <a name="filespaces"></a>
    <h1>Failed Filespaces / Filespaces manqu&eacute;s</h1>
    <table cellspacing="0" cellpadding="0" border="0">
      <tr>
        <th class="left">TSM Server</th>
        <th class="left">Node Name</th>
        <th class="left">Node Group</th>
        <th class="left">Filespaces</th>
        <th class="nowrap">Last backup date</th>
        <th>Days since last backup</th>
      </tr>
    % for f in filespaces:
      <tr>
        <td class="left">${f['tsmserver']}</td>
        <td class="left">${f['node']}</td>
        <td class="left">${f['GROUP']}</td>
        <td class="left">${ '<br/>'.join(f['FILESPACES']) }</td>
        <td class="nowrap">${ '<br/>'.join([toDateStr(x) for x in f['last_completed']]) }</td>
        <td>${ '<br/>'.join([toInt(x) for x in f['days_since']]) }</td>
      </tr>
    % endfor
    </table>
    % endif
</%def>
